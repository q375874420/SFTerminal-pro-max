/**
 * Agent å·¥å…·å®šä¹‰
 */
import type { ToolDefinition } from '../ai.service'
import type { McpService } from '../mcp.service'

/**
 * è·å–å¯ç”¨å·¥å…·å®šä¹‰
 * @param mcpService å¯é€‰çš„ MCP æœåŠ¡ï¼Œç”¨äºåŠ¨æ€åŠ è½½ MCP å·¥å…·
 */
export function getAgentTools(mcpService?: McpService): ToolDefinition[] {
  // å†…ç½®å·¥å…·
  const builtinTools: ToolDefinition[] = [
    {
      type: 'function',
      function: {
        name: 'execute_command',
        description: `åœ¨å½“å‰ç»ˆç«¯æ‰§è¡Œ shell å‘½ä»¤ã€‚

**ç¦æ­¢ä½¿ç”¨çš„å‘½ä»¤**ï¼ˆä¼šè¢«ç³»ç»Ÿæ‹’ç»ï¼‰ï¼š
- vimã€viã€nanoã€emacs ç­‰ç¼–è¾‘å™¨ â†’ è¯·ä½¿ç”¨ write_file å·¥å…·
- tmuxã€screen ç­‰ç»ˆç«¯å¤ç”¨å™¨ â†’ ä¸æ”¯æŒ
- mcã€ranger ç­‰å…¨å±æ–‡ä»¶ç®¡ç†å™¨ â†’ è¯·ä½¿ç”¨ lsã€cd ç­‰å‘½ä»¤

**æŒç»­è¿è¡Œçš„å‘½ä»¤**ï¼ˆå‘é€åç«‹å³è¿”å›ï¼Œä¸ç­‰å¾…è¶…æ—¶ï¼‰ï¼š
- tail -fã€pingã€watchã€topã€htopã€journalctl -f ç­‰ â†’ å‘½ä»¤å¯åŠ¨åç«‹å³è¿”å›
- ç”¨ get_terminal_context æŸ¥çœ‹è¾“å‡º
- ç”¨ send_control_key("ctrl+c") æˆ– send_control_key("q") åœæ­¢

**éœ€è¦ä½ è‡ªè¡Œæ§åˆ¶çš„å‘½ä»¤**ï¼š
- lessã€more ç­‰åˆ†é¡µç¨‹åº â†’ ç”¨ check_terminal_status è§‚å¯Ÿï¼Œå‘é€ q é€€å‡º
- äº¤äº’å¼ç¡®è®¤ï¼ˆapt install ç­‰ï¼‰â†’ ç³»ç»Ÿä¼šè‡ªåŠ¨æ·»åŠ  -y å‚æ•°

è¿”å›å€¼åŒ…å«ï¼š
- **success**: å‘½ä»¤æ˜¯å¦æˆåŠŸæ‰§è¡Œï¼ˆtrue/falseï¼‰
- **output**: å‘½ä»¤çš„å®Œæ•´è¾“å‡ºå†…å®¹ï¼ˆè¶…æ—¶æ—¶ä¼šè¿”å›ç»ˆç«¯æœ€å 50 è¡Œï¼‰
- **error**: å¤±è´¥æ—¶çš„é”™è¯¯ä¿¡æ¯å’Œæ¢å¤å»ºè®®
- **isRunning**: ä¸º true æ—¶è¡¨ç¤ºå‘½ä»¤ä»åœ¨è¿è¡Œï¼ˆæŒç»­è¿è¡Œå‘½ä»¤æˆ–é•¿è€—æ—¶å‘½ä»¤è¶…æ—¶ï¼‰

æ³¨æ„ï¼šsuccess=false æ—¶åº”åˆ†æ output/error å†…å®¹åˆ¤æ–­é—®é¢˜åŸå› ã€‚`,
        parameters: {
          type: 'object',
          properties: {
            command: {
              type: 'string',
              description: 'è¦æ‰§è¡Œçš„ shell å‘½ä»¤'
            }
          },
          required: ['command']
        }
      }
    },
    {
      type: 'function',
      function: {
        name: 'check_terminal_status',
        description: `æ£€æŸ¥ç»ˆç«¯çŠ¶æ€ï¼Œè¿”å›è¯¦ç»†çš„çŠ¶æ€åˆ†æå’Œæœ€è¿‘è¾“å‡ºã€‚è¿”å›ï¼š
1. **ç»ˆç«¯ä¿¡æ¯**: ç±»å‹ã€å½“å‰ç›®å½•ã€æœ€è¿‘å‘½ä»¤ã€ç”¨æˆ·@ä¸»æœºã€æ´»è·ƒç¯å¢ƒ
2. **çŠ¶æ€æ£€æµ‹**: 
   - è¾“å…¥ç­‰å¾…ï¼ˆå¯†ç /ç¡®è®¤/é€‰æ‹©/åˆ†é¡µå™¨/ç¼–è¾‘å™¨ï¼‰åŠå»ºè®®å“åº”
   - è¿›ç¨‹çŠ¶æ€ï¼ˆç©ºé—²/å¿™ç¢Œ/å¡æ­»ï¼‰
   - å¯å¦æ‰§è¡Œæ–°å‘½ä»¤
3. **è¾“å‡ºç±»å‹è¯†åˆ«**: è¿›åº¦æ¡/ç¼–è¯‘/æµ‹è¯•/æ—¥å¿—æµ/é”™è¯¯/è¡¨æ ¼
4. **ç»ˆç«¯è¾“å‡º**: æœ€è¿‘ 50 è¡Œï¼ˆä¸å—ç”¨æˆ·æ»šåŠ¨çª—å£å½±å“ï¼‰

æœ¬åœ°ç»ˆç«¯åŸºäºè¿›ç¨‹æ£€æµ‹çŠ¶æ€å‡†ç¡®ï¼›SSH ç»ˆç«¯éœ€ç»“åˆè¾“å‡ºå†…å®¹åˆ¤æ–­ã€‚`,
        parameters: {
          type: 'object',
          properties: {}
        }
      }
    },
    {
      type: 'function',
      function: {
        name: 'get_terminal_context',
        description: 'è·å–ç»ˆç«¯æœ€è¿‘çš„è¾“å‡ºå†…å®¹ï¼ˆä»æœ«å°¾å‘å‰è¯»å–ï¼‰',
        parameters: {
          type: 'object',
          properties: {
            lines: {
              type: 'number',
              description: 'è·å–çš„è¡Œæ•°ï¼Œé»˜è®¤ 50ï¼Œæœ€å¤§ 500'
            }
          }
        }
      }
    },
    {
      type: 'function',
      function: {
        name: 'send_control_key',
        description: 'å‘ç»ˆç«¯å‘é€æ§åˆ¶é”®ã€‚å½“ç»ˆç«¯æœ‰å‘½ä»¤å¡ä½æˆ–éœ€è¦é€€å‡ºç¨‹åºæ—¶ä½¿ç”¨ã€‚å»ºè®®å…ˆç”¨ check_terminal_status ç¡®è®¤ç»ˆç«¯çŠ¶æ€ã€‚',
        parameters: {
          type: 'object',
          properties: {
            key: {
              type: 'string',
              enum: ['ctrl+c', 'ctrl+d', 'ctrl+z', 'enter', 'q'],
              description: 'ctrl+c: ä¸­æ–­å‘½ä»¤; ctrl+d: å‘é€EOF; ctrl+z: æš‚åœ; enter: å›è½¦; q: é€€å‡ºåˆ†é¡µå™¨'
            }
          },
          required: ['key']
        }
      }
    },
    {
      type: 'function',
      function: {
        name: 'send_input',
        description: `å‘ç»ˆç«¯å‘é€æ–‡æœ¬è¾“å…¥ã€‚ç”¨äºå“åº”ç»ˆç«¯çš„äº¤äº’å¼æç¤ºï¼Œå¦‚ï¼š
- ç¡®è®¤æç¤º (y/n, yes/no)
- æ•°å­—é€‰æ‹© (1, 2, 3...)
- å¯†ç æˆ–å…¶ä»–ç®€çŸ­è¾“å…¥

æ³¨æ„ï¼š
- é»˜è®¤ä¼šè‡ªåŠ¨æ·»åŠ å›è½¦é”®å‘é€è¾“å…¥
- å¦‚æœåªæƒ³è¾“å…¥æ–‡å­—ä¸å‘é€ï¼Œè®¾ç½® press_enter ä¸º false
- å»ºè®®å…ˆç”¨ check_terminal_status ç¡®è®¤ç»ˆç«¯æ­£åœ¨ç­‰å¾…è¾“å…¥`,
        parameters: {
          type: 'object',
          properties: {
            text: {
              type: 'string',
              description: 'è¦å‘é€çš„æ–‡æœ¬å†…å®¹ï¼Œå¦‚ "y", "n", "1", "yes" ç­‰'
            },
            press_enter: {
              type: 'boolean',
              description: 'æ˜¯å¦åœ¨æ–‡æœ¬åè‡ªåŠ¨æŒ‰å›è½¦é”®ï¼Œé»˜è®¤ true'
            }
          },
          required: ['text']
        }
      }
    },
    {
      type: 'function',
      function: {
        name: 'read_file',
        description: `è¯»å–æœ¬åœ°æ–‡ä»¶å†…å®¹ã€‚æ”¯æŒå¤šç§è¯»å–æ–¹å¼ï¼š
1. **å®Œæ•´è¯»å–**ï¼šä¸æŒ‡å®šä»»ä½•èŒƒå›´å‚æ•°ï¼Œè¯»å–æ•´ä¸ªæ–‡ä»¶ï¼ˆæ–‡ä»¶éœ€å°äº 500KBï¼‰
2. **æŒ‰è¡ŒèŒƒå›´è¯»å–**ï¼šä½¿ç”¨ start_line å’Œ end_line æŒ‡å®šè¡Œå·èŒƒå›´ï¼ˆä»1å¼€å§‹ï¼‰
3. **æŒ‰è¡Œæ•°è¯»å–**ï¼šä½¿ç”¨ max_lines æŒ‡å®šä»æ–‡ä»¶å¼€å¤´è¯»å–çš„è¡Œæ•°
4. **ä»æœ«å°¾è¯»å–**ï¼šä½¿ç”¨ tail_lines æŒ‡å®šä»æ–‡ä»¶æœ«å°¾è¯»å–çš„è¡Œæ•°
5. **æ–‡ä»¶ä¿¡æ¯æŸ¥è¯¢**ï¼šåªè®¾ç½® info_only=trueï¼Œè·å–æ–‡ä»¶å¤§å°ã€è¡Œæ•°ç­‰ä¿¡æ¯ï¼Œä¸è¯»å–å†…å®¹

âš ï¸ **ä»…æ”¯æŒæœ¬åœ°æ–‡ä»¶**ï¼šæ­¤å·¥å…·åªèƒ½è¯»å–è¿è¡Œç»ˆç«¯ç¨‹åºçš„æœ¬åœ°æœºå™¨ä¸Šçš„æ–‡ä»¶ã€‚
å¯¹äº SSH è¿œç¨‹ä¸»æœºï¼Œè¯·ä½¿ç”¨ execute_command æ‰§è¡Œ cat/head/tail/sed ç­‰å‘½ä»¤è¯»å–è¿œç¨‹æ–‡ä»¶ã€‚

å¯¹äºå¤§æ–‡ä»¶ï¼Œå»ºè®®å…ˆä½¿ç”¨ info_only=true æŸ¥çœ‹æ–‡ä»¶ä¿¡æ¯ï¼Œç„¶åæ ¹æ®éœ€è¦è¯»å–ç‰¹å®šéƒ¨åˆ†ã€‚`,
        parameters: {
          type: 'object',
          properties: {
            path: {
              type: 'string',
              description: 'æ–‡ä»¶è·¯å¾„ï¼ˆç»å¯¹è·¯å¾„æˆ–ç›¸å¯¹äºå½“å‰ç›®å½•ï¼‰'
            },
            info_only: {
              type: 'boolean',
              description: 'ä»…è·å–æ–‡ä»¶ä¿¡æ¯ï¼ˆå¤§å°ã€è¡Œæ•°ç­‰ï¼‰ï¼Œä¸è¯»å–å†…å®¹ã€‚å¯¹äºå¤§æ–‡ä»¶ï¼Œå»ºè®®å…ˆæŸ¥è¯¢ä¿¡æ¯å†å†³å®šè¯»å–èŒƒå›´ã€‚'
            },
            start_line: {
              type: 'number',
              description: 'èµ·å§‹è¡Œå·ï¼ˆä»1å¼€å§‹ï¼‰ã€‚ä¸ end_line é…åˆä½¿ç”¨å¯è¯»å–æŒ‡å®šè¡ŒèŒƒå›´ã€‚'
            },
            end_line: {
              type: 'number',
              description: 'ç»“æŸè¡Œå·ï¼ˆåŒ…å«ï¼‰ã€‚ä¸ start_line é…åˆä½¿ç”¨å¯è¯»å–æŒ‡å®šè¡ŒèŒƒå›´ã€‚'
            },
            max_lines: {
              type: 'number',
              description: 'ä»æ–‡ä»¶å¼€å¤´è¯»å–çš„æœ€å¤§è¡Œæ•°ã€‚ä¾‹å¦‚è®¾ç½®ä¸º 100 å¯è¯»å–å‰100è¡Œã€‚'
            },
            tail_lines: {
              type: 'number',
              description: 'ä»æ–‡ä»¶æœ«å°¾è¯»å–çš„è¡Œæ•°ã€‚ä¾‹å¦‚è®¾ç½®ä¸º 50 å¯è¯»å–æœ€å50è¡Œï¼ˆç±»ä¼¼ tail -n 50ï¼‰ã€‚'
            }
          },
          required: ['path']
        }
      }
    },
    {
      type: 'function',
      function: {
        name: 'write_file',
        description: `å†™å…¥æˆ–åˆ›å»ºæ–‡ä»¶ã€‚æ”¯æŒæœ¬åœ°æ–‡ä»¶å’Œ SSH è¿œç¨‹æ–‡ä»¶ã€‚

**æœ¬åœ°ç»ˆç«¯**ï¼šæ”¯æŒå¤šç§å†™å…¥æ¨¡å¼ï¼š
1. **æ–°å»ºæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰**ï¼šmode='create'ï¼Œä»…åˆ›å»ºæ–°æ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶å·²å­˜åœ¨åˆ™æŠ¥é”™
2. **è¦†ç›–æ¨¡å¼**ï¼šmode='overwrite'ï¼Œç”¨ content æ›¿æ¢æ•´ä¸ªæ–‡ä»¶ï¼ˆæ–‡ä»¶å­˜åœ¨ä¼šè¦†ç›–ï¼‰
3. **è¿½åŠ æ¨¡å¼**ï¼šmode='append'ï¼Œåœ¨æ–‡ä»¶æœ«å°¾è¿½åŠ  content
4. **æ’å…¥æ¨¡å¼**ï¼šmode='insert'ï¼Œåœ¨ insert_at_line è¡Œä¹‹å‰æ’å…¥ content
5. **è¡Œæ›¿æ¢æ¨¡å¼**ï¼šmode='replace_lines'ï¼Œç”¨ content æ›¿æ¢ start_line åˆ° end_line çš„å†…å®¹
6. **æ­£åˆ™æ›¿æ¢æ¨¡å¼**ï¼šmode='regex_replace'ï¼Œç”¨æ­£åˆ™è¡¨è¾¾å¼æŸ¥æ‰¾æ›¿æ¢

**SSH è¿œç¨‹ç»ˆç«¯** - ä»…æ”¯æŒ overwriteã€create å’Œ append æ¨¡å¼ï¼š
- é€šè¿‡ SFTP å†™å…¥ï¼Œä¸ç”¨æ‹…å¿ƒç‰¹æ®Šå­—ç¬¦è½¬ä¹‰é—®é¢˜
- é€‚åˆï¼šåˆ›å»ºæ–°æ–‡ä»¶ã€å®Œå…¨æ›¿æ¢æ–‡ä»¶ã€è¿½åŠ æ—¥å¿—/é…ç½®
- **ä¸æ”¯æŒ** insertã€replace_linesã€regex_replace æ¨¡å¼
- éœ€è¦å±€éƒ¨ä¿®æ”¹æ—¶ï¼Œè¯·ç”¨ execute_command æ‰§è¡Œå‘½ä»¤ï¼Œå¦‚sedã€awkç­‰

âš ï¸ **é‡è¦æ–‡ä»¶è¯·å…ˆå¤‡ä»½**ï¼šä¿®æ”¹é…ç½®æ–‡ä»¶ã€è„šæœ¬ç­‰é‡è¦æ–‡ä»¶å‰ï¼Œå¿…é¡»å…ˆæ‰§è¡Œå¤‡ä»½å‘½ä»¤ï¼š
\`cp file.txt file.txt.$(date +%Y%m%d_%H%M%S).bak\`
ä¸éœ€è¦å¤‡ä»½ï¼šæ–°å»ºæ–‡ä»¶ã€ä¸´æ—¶æ–‡ä»¶ã€æ—¥å¿—æ–‡ä»¶ã€æ˜ç¡®ä¸é‡è¦çš„æ–‡ä»¶`,
        parameters: {
          type: 'object',
          properties: {
            path: {
              type: 'string',
              description: 'æ–‡ä»¶è·¯å¾„ï¼ˆæœ¬åœ°æˆ–è¿œç¨‹ï¼Œæ ¹æ®å½“å‰ç»ˆç«¯ç±»å‹è‡ªåŠ¨è¯†åˆ«ï¼‰'
            },
            content: {
              type: 'string',
              description: 'æ–‡ä»¶å†…å®¹ï¼ˆè¦†ç›–/è¿½åŠ /æ’å…¥/è¡Œæ›¿æ¢æ¨¡å¼å¿…å¡«ï¼‰'
            },
            mode: {
              type: 'string',
              enum: ['create', 'overwrite', 'append', 'insert', 'replace_lines', 'regex_replace'],
              description: 'å†™å…¥æ¨¡å¼ï¼šcreateï¼ˆæ–°å»ºï¼Œé»˜è®¤ï¼Œæ–‡ä»¶å­˜åœ¨åˆ™æŠ¥é”™ï¼‰ã€overwriteï¼ˆè¦†ç›–ï¼‰ã€appendï¼ˆè¿½åŠ ï¼‰ã€insertï¼ˆæ’å…¥ï¼‰ã€replace_linesï¼ˆè¡Œæ›¿æ¢ï¼‰ã€regex_replaceï¼ˆæ­£åˆ™æ›¿æ¢ï¼‰'
            },
            insert_at_line: {
              type: 'number',
              description: 'æ’å…¥ä½ç½®çš„è¡Œå·ï¼ˆinsert æ¨¡å¼å¿…å¡«ï¼Œåœ¨è¯¥è¡Œä¹‹å‰æ’å…¥ï¼Œä»1å¼€å§‹ï¼‰'
            },
            start_line: {
              type: 'number',
              description: 'æ›¿æ¢èµ·å§‹è¡Œå·ï¼ˆreplace_lines æ¨¡å¼å¿…å¡«ï¼Œä»1å¼€å§‹ï¼ŒåŒ…å«è¯¥è¡Œï¼‰'
            },
            end_line: {
              type: 'number',
              description: 'æ›¿æ¢ç»“æŸè¡Œå·ï¼ˆreplace_lines æ¨¡å¼å¿…å¡«ï¼ŒåŒ…å«è¯¥è¡Œï¼‰'
            },
            pattern: {
              type: 'string',
              description: 'æ­£åˆ™è¡¨è¾¾å¼ï¼ˆregex_replace æ¨¡å¼å¿…å¡«ï¼‰'
            },
            replacement: {
              type: 'string',
              description: 'æ›¿æ¢å†…å®¹ï¼ˆregex_replace æ¨¡å¼å¿…å¡«ï¼Œå¯ä½¿ç”¨ $1 $2 ç­‰æ•è·ç»„ï¼‰'
            },
            replace_all: {
              type: 'boolean',
              description: 'æ˜¯å¦æ›¿æ¢æ‰€æœ‰åŒ¹é…é¡¹ï¼ˆregex_replace æ¨¡å¼ï¼Œé»˜è®¤ trueï¼‰'
            }
          },
          required: ['path']
        }
      }
    },
    {
      type: 'function',
      function: {
        name: 'remember_info',
        description: `ä¿å­˜å‘ç°åˆ°çŸ¥è¯†åº“ï¼Œä¸‹æ¬¡äº¤äº’æ—¶ä¼šåŸºäºè¯­ä¹‰ç›¸å…³æ€§è‡ªåŠ¨æä¾›è¿™äº›ä¿¡æ¯ã€‚çŸ¥è¯†åº“å®¹é‡å……è¶³ï¼Œé¼“åŠ±å¤šè®°å½•æœ‰ä»·å€¼çš„ä¿¡æ¯ã€‚

**ç§¯æè®°å½•ä»¥ä¸‹å†…å®¹**ï¼š
- **ç›®å½•å’Œè·¯å¾„**ï¼šé¡¹ç›®ç›®å½•ã€é…ç½®æ–‡ä»¶ä½ç½®ã€æ—¥å¿—ä½ç½®ã€æ•°æ®ç›®å½•ç­‰
- **ç¯å¢ƒå’Œé…ç½®**ï¼šJDK/Python/Node ç‰ˆæœ¬ã€ç¯å¢ƒå˜é‡ã€ç³»ç»Ÿå‚æ•°
- **æœåŠ¡å’Œç«¯å£**ï¼šå„æœåŠ¡çš„ç«¯å£ã€ä¾èµ–å…³ç³»ã€å¯åŠ¨æ–¹å¼ã€é…ç½®æ–‡ä»¶ä½ç½®
- **ç½‘ç»œä¿¡æ¯**ï¼šIP åœ°å€ã€åŸŸåã€é˜²ç«å¢™è§„åˆ™ã€ç½‘ç»œæ‹“æ‰‘
- **è½¯ä»¶å’Œç‰ˆæœ¬**ï¼šå®‰è£…çš„è½¯ä»¶ã€ç‰ˆæœ¬å·ã€å®‰è£…è·¯å¾„
- **å®šæ—¶ä»»åŠ¡**ï¼šcrontab é…ç½®ã€å®šæ—¶è„šæœ¬ä½ç½®
- **ç”¨æˆ·åå¥½**ï¼šä¹ æƒ¯ç”¨çš„ç¼–è¾‘å™¨ã€å¸¸ç”¨å‘½ä»¤ã€æ“ä½œä¹ æƒ¯
- **é—®é¢˜å’Œæ–¹æ¡ˆ**ï¼šé‡åˆ°çš„é—®é¢˜åŠè§£å†³æ–¹æ³•ï¼Œé¿å…é‡å¤æ’æŸ¥
- **ç³»ç»Ÿç‰¹æ€§**ï¼šç³»ç»Ÿé™åˆ¶ã€ç‰¹æ®Šé…ç½®ã€æ³¨æ„äº‹é¡¹
- **å¸¸ç”¨å‘½ä»¤**ï¼šè¯¥ä¸»æœºç‰¹æœ‰çš„å¯åŠ¨/åœæ­¢/éƒ¨ç½²å‘½ä»¤

**ä¸è¦è®°å½•**ï¼š
- çº¯åŠ¨æ€æ•°æ®ï¼ˆå¦‚"å½“å‰ CPU 85%"ï¼Œä½†"CPU ç»å¸¸è¶…è¿‡ 80% éœ€è¦å…³æ³¨"å¯ä»¥è®°ï¼‰
- å¤§æ®µå‘½ä»¤è¾“å‡ºï¼ˆä½†è¾“å‡ºä¸­çš„å…³é”®å‘ç°è¦è®°å½•ï¼‰

**è®°å½•è¦æ±‚**ï¼šè·¯å¾„ã€ç«¯å£ã€ç‰ˆæœ¬ç­‰å…³é”®ä¿¡æ¯å¿…é¡»å®Œæ•´å‡†ç¡®ï¼Œç¦æ­¢ç¼©å†™ã€‚`,
        parameters: {
          type: 'object',
          properties: {
            info: {
              type: 'string',
              description: 'è¦è®°ä½çš„ä¿¡æ¯ã€‚è·¯å¾„ã€ç«¯å£ç­‰å…³é”®ä¿¡æ¯å¿…é¡»å®Œæ•´å‡†ç¡®'
            }
          },
          required: ['info']
        }
      }
    },
    {
      type: 'function',
      function: {
        name: 'search_knowledge',
        description: 'æœç´¢ç”¨æˆ·çš„çŸ¥è¯†åº“æ–‡æ¡£ã€‚æœç´¢ç»“æœå·²åŒ…å«æ–‡æ¡£å†…å®¹ï¼Œç›´æ¥ä½¿ç”¨å³å¯ã€‚',
        parameters: {
          type: 'object',
          properties: {
            query: {
              type: 'string',
              description: 'ç®€çŸ­çš„æœç´¢è¯ï¼Œ1-3ä¸ªæ ¸å¿ƒå…³é”®è¯å³å¯ï¼Œé¿å…å †ç Œ'
            },
            limit: {
              type: 'number',
              description: 'è¿”å›ç»“æœæ•°é‡ï¼Œé»˜è®¤ 5ï¼Œæœ€å¤§ 20'
            }
          },
          required: ['query']
        }
      }
    },
    {
      type: 'function',
      function: {
        name: 'wait',
        description: `ç­‰å¾…æŒ‡å®šæ—¶é—´åç»§ç»­æ‰§è¡Œã€‚ç”¨äºé•¿è€—æ—¶å‘½ä»¤æ‰§è¡ŒæœŸé—´ï¼Œé¿å…é¢‘ç¹æŸ¥è¯¢çŠ¶æ€æ¶ˆè€—æ­¥éª¤ã€‚

ä½¿ç”¨åœºæ™¯ï¼š
- æ‰§è¡Œæ„å»ºã€ç¼–è¯‘ç­‰é•¿æ—¶é—´å‘½ä»¤åï¼Œç­‰å¾…ä¸€æ®µæ—¶é—´å†æ£€æŸ¥ç»“æœ
- ç­‰å¾…æœåŠ¡å¯åŠ¨ã€è¿›ç¨‹å®Œæˆç­‰
- ç»™è‡ªå·±"ä¼‘æ¯"ä¸€ä¸‹ï¼Œç¨åç»§ç»­

ä½ å¯ä»¥è®¾ç½®ä¸€æ¡æœ‰è¶£çš„ç­‰å¾…æ¶ˆæ¯ï¼Œè®©ç­‰å¾…è¿‡ç¨‹æ›´ç”ŸåŠ¨ï¼`,
        parameters: {
          type: 'object',
          properties: {
            seconds: {
              type: 'number',
              description: 'ç­‰å¾…çš„ç§’æ•°ã€‚å»ºè®®æ ¹æ®ä»»åŠ¡ç±»å‹é€‰æ‹©ï¼šç®€å•æ£€æŸ¥ 10-30 ç§’ï¼Œæ„å»ºä»»åŠ¡ 60-180 ç§’ï¼Œå¤§å‹ç¼–è¯‘ 300+ ç§’'
            },
            message: {
              type: 'string',
              description: 'ç­‰å¾…æ—¶æ˜¾ç¤ºçš„æ¶ˆæ¯ã€‚å¯ä»¥æœ‰è¶£ä¸€ç‚¹ï¼Œå¦‚"æˆ‘å»å–æ¯å’–å•¡â˜•"ã€"å®¹æˆ‘æ€è€ƒç‰‡åˆ»ğŸ¤”"ã€"ç¼–è¯‘ä¸­ï¼Œå…ˆæ‘¸ä¼šå„¿é±¼ğŸŸ"'
            }
          },
          required: ['seconds']
        }
      }
    },
    {
      type: 'function',
      function: {
        name: 'ask_user',
        description: `å‘ç”¨æˆ·æé—®å¹¶ç­‰å¾…å›å¤ã€‚å½“ä½ éœ€è¦æ›´å¤šä¿¡æ¯æ‰èƒ½ç»§ç»­æ‰§è¡Œä»»åŠ¡æ—¶ä½¿ç”¨æ­¤å·¥å…·ã€‚

**æ ¸å¿ƒåŸåˆ™ï¼šåªåœ¨åˆ¶å®šè®¡åˆ’æ—¶æé—®**
- å¼€å§‹æ‰§è¡Œå‰ï¼Œå…ˆé—®æ¸…æ¥šæ‰€æœ‰ç–‘é—®
- è®¡åˆ’ç¡®å®šåé¡ºç•…æ‰§è¡Œï¼Œä¸å†æ‰“æ–­ç”¨æˆ·
- æ‰§è¡Œä¸­é‡åˆ°æ„å¤–ï¼Œä¼˜å…ˆç”¨åˆç†é»˜è®¤å€¼ï¼Œå®åœ¨æ— æ³•ç»§ç»­æ‰æé—®

ä½¿ç”¨åœºæ™¯ï¼š
- éœ€è¦ç”¨æˆ·æä¾›ç‰¹å®šä¿¡æ¯ï¼ˆå¦‚é…ç½®å‚æ•°ã€è·¯å¾„ã€é€‰é¡¹ç­‰ï¼‰
- ä»»åŠ¡æœ‰å¤šç§æ‰§è¡Œæ–¹å¼ï¼Œéœ€è¦ç”¨æˆ·é€‰æ‹©
- æ‰§è¡Œå‰éœ€è¦ç”¨æˆ·ç¡®è®¤å…³é”®å†³ç­–
- é‡åˆ°æ­§ä¹‰æˆ–ä¸ç¡®å®šæ€§ï¼Œéœ€è¦æ¾„æ¸…ç”¨æˆ·æ„å›¾

æ³¨æ„ï¼š
- é—®é¢˜è¦æ¸…æ™°ã€å…·ä½“ï¼Œè®©ç”¨æˆ·çŸ¥é“å¦‚ä½•å›ç­”
- å¦‚æœæœ‰å¯é€‰é¡¹ï¼Œå¯ä»¥åˆ—å‡ºä¾›ç”¨æˆ·é€‰æ‹©ï¼ˆæœ€å¤š 10 ä¸ªé€‰é¡¹ï¼‰
- è°ƒç”¨æ­¤å·¥å…·åä¼šæš‚åœæ‰§è¡Œï¼Œç›´åˆ°ç”¨æˆ·å›å¤
- å¯ä»¥é€šè¿‡ timeout å‚æ•°è®¾ç½®ç­‰å¾…æ—¶é•¿ï¼ˆé»˜è®¤ 120 ç§’ï¼‰`,
        parameters: {
          type: 'object',
          properties: {
            question: {
              type: 'string',
              description: 'è¦å‘ç”¨æˆ·æå‡ºçš„é—®é¢˜ï¼Œåº”æ¸…æ™°æ˜ç¡®'
            },
            options: {
              type: 'array',
              items: { type: 'string' },
              description: 'å¯é€‰é¡¹åˆ—è¡¨ï¼ˆå¦‚æœé—®é¢˜æœ‰å›ºå®šé€‰é¡¹ï¼Œæœ€å¤š 10 ä¸ªï¼‰ã€‚ä¾‹å¦‚ï¼š["é€‰é¡¹A", "é€‰é¡¹B", "é€‰é¡¹C"]'
            },
            allow_multiple: {
              type: 'boolean',
              description: 'æ˜¯å¦å…è®¸å¤šé€‰ï¼ˆé»˜è®¤ false ä¸ºå•é€‰ï¼‰ã€‚è®¾ä¸º true æ—¶ç”¨æˆ·å¯ä»¥é€‰æ‹©å¤šä¸ªé€‰é¡¹'
            },
            default_value: {
              type: 'string',
              description: 'é»˜è®¤å€¼ï¼ˆå¦‚æœç”¨æˆ·ç›´æ¥æŒ‰å›è½¦æˆ–ä¸å›å¤æ—¶ä½¿ç”¨ï¼‰'
            },
            timeout: {
              type: 'number',
              description: 'ç­‰å¾…ç”¨æˆ·å›å¤çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ã€‚é»˜è®¤ 120 ç§’ï¼Œæœ€çŸ­ 30 ç§’ï¼Œæœ€é•¿ 600 ç§’ã€‚ç®€å•é€‰æ‹©é¢˜å¯è®¾çŸ­äº›ï¼ˆå¦‚ 60 ç§’ï¼‰ï¼Œéœ€è¦ç”¨æˆ·æŸ¥èµ„æ–™çš„é—®é¢˜å¯è®¾é•¿äº›ï¼ˆå¦‚ 300 ç§’ï¼‰ã€‚'
            }
          },
          required: ['question']
        }
      }
    },
    // ==================== Plan/Todo å·¥å…· ====================
    {
      type: 'function',
      function: {
        name: 'create_plan',
        description: `åˆ›å»ºä»»åŠ¡æ‰§è¡Œè®¡åˆ’ï¼Œå‘ç”¨æˆ·å±•ç¤ºæ¸…æ™°çš„æ‰§è¡Œæ­¥éª¤å’Œè¿›åº¦ã€‚

**ä½•æ—¶ä½¿ç”¨**ï¼š
- ä»»åŠ¡æ¶‰åŠ 3 ä¸ªä»¥ä¸Šæ­¥éª¤
- å¤šç³»ç»Ÿ/å¤šæœåŠ¡æ“ä½œï¼ˆå¦‚éƒ¨ç½²ã€è¿ç§»ï¼‰
- è¯Šæ–­æ’æŸ¥ç±»ä»»åŠ¡
- ç”¨æˆ·è¦æ±‚"å¸®æˆ‘è§„åˆ’"æˆ–éœ€è¦äº†è§£æ•´ä½“è¿›åº¦

**ä½•æ—¶ä¸éœ€è¦**ï¼š
- å•ä¸ªç®€å•æŸ¥è¯¢æˆ– 1-2 æ­¥æ“ä½œ
- ç”¨æˆ·è¯´"ç›´æ¥åš"/"å¿«é€Ÿå¸®æˆ‘"

åˆ›å»ºè®¡åˆ’åï¼Œåœ¨æ‰§è¡Œæ¯ä¸ªæ­¥éª¤æ—¶ä½¿ç”¨ update_plan æ›´æ–°çŠ¶æ€ã€‚`,
        parameters: {
          type: 'object',
          properties: {
            title: {
              type: 'string',
              description: 'è®¡åˆ’æ ‡é¢˜ï¼Œç®€çŸ­æè¿°ä»»åŠ¡ç›®æ ‡ï¼ˆå¦‚"æœåŠ¡å™¨æ€§èƒ½è¯Šæ–­"ã€"éƒ¨ç½² Node.js åº”ç”¨"ï¼‰'
            },
            steps: {
              type: 'array',
              items: {
                type: 'object',
                properties: {
                  title: { 
                    type: 'string', 
                    description: 'æ­¥éª¤æ ‡é¢˜ï¼Œç®€æ´æ˜äº†ï¼ˆå¦‚"æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½"ã€"å®‰è£…ä¾èµ–"ï¼‰' 
                  },
                  description: { 
                    type: 'string', 
                    description: 'æ­¥éª¤è¯¦ç»†è¯´æ˜ï¼ˆå¯é€‰ï¼Œè¯´æ˜è¿™ä¸€æ­¥è¦åšä»€ä¹ˆï¼‰' 
                  }
                },
                required: ['title']
              },
              description: 'è®¡åˆ’æ­¥éª¤åˆ—è¡¨ï¼Œå»ºè®® 3-8 æ­¥ï¼Œä¸è¶…è¿‡ 10 æ­¥'
            }
          },
          required: ['title', 'steps']
        }
      }
    },
    {
      type: 'function',
      function: {
        name: 'update_plan',
        description: `æ›´æ–°è®¡åˆ’æ­¥éª¤çŠ¶æ€ã€‚åœ¨æ‰§è¡Œæ¯ä¸ªæ­¥éª¤å‰åè°ƒç”¨ï¼Œè®©ç”¨æˆ·å®æ—¶äº†è§£è¿›åº¦ã€‚

**ä½¿ç”¨æµç¨‹**ï¼š
1. å¼€å§‹æ­¥éª¤å‰ï¼šupdate_plan(step_index, "in_progress")
2. æ­¥éª¤å®Œæˆåï¼šupdate_plan(step_index, "completed", "ç»“æœè¯´æ˜")
3. æ­¥éª¤å¤±è´¥æ—¶ï¼šupdate_plan(step_index, "failed", "å¤±è´¥åŸå› ")
4. è·³è¿‡æ­¥éª¤æ—¶ï¼šupdate_plan(step_index, "skipped", "è·³è¿‡åŸå› ")`,
        parameters: {
          type: 'object',
          properties: {
            step_index: {
              type: 'number',
              description: 'æ­¥éª¤ç´¢å¼•ï¼ˆä» 0 å¼€å§‹ï¼‰'
            },
            status: {
              type: 'string',
              enum: ['pending', 'in_progress', 'completed', 'failed', 'skipped'],
              description: 'æ­¥éª¤çŠ¶æ€ï¼špendingï¼ˆç­‰å¾…ï¼‰ã€in_progressï¼ˆæ‰§è¡Œä¸­ï¼‰ã€completedï¼ˆå®Œæˆï¼‰ã€failedï¼ˆå¤±è´¥ï¼‰ã€skippedï¼ˆè·³è¿‡ï¼‰'
            },
            result: {
              type: 'string',
              description: 'æ­¥éª¤ç»“æœè¯´æ˜ï¼ˆå¯é€‰ï¼Œå¦‚"è´Ÿè½½æ­£å¸¸: 0.52"ã€"å‘ç° 3 ä¸ªé”™è¯¯"ï¼‰'
            }
          },
          required: ['step_index', 'status']
        }
      }
    },
    {
      type: 'function',
      function: {
        name: 'clear_plan',
        description: `å½’æ¡£å½“å‰è®¡åˆ’ã€‚å°†è®¡åˆ’åŠå…¶æ‰§è¡Œæƒ…å†µä¿å­˜åˆ°å†å²è®°å½•ä¸­ï¼Œç”¨æˆ·å¯éšæ—¶æŸ¥çœ‹ã€‚

**ä½¿ç”¨åœºæ™¯**ï¼š
- è®¡åˆ’æ‰§è¡Œå®Œæ¯•åéœ€è¦å¼€å§‹æ–°ä»»åŠ¡
- è®¡åˆ’æ‰§è¡Œå¤±è´¥åéœ€è¦é‡æ–°è§„åˆ’
- ç”¨æˆ·è¦æ±‚æ”¾å¼ƒå½“å‰è®¡åˆ’
- ä»»åŠ¡ç›®æ ‡å‘ç”Ÿå˜åŒ–éœ€è¦åˆ¶å®šæ–°è®¡åˆ’

å½’æ¡£åè®¡åˆ’ä¼šä¿å­˜åœ¨æ‰§è¡Œæ­¥éª¤ä¸­ï¼Œç”¨æˆ·å¯ä»¥ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…ã€‚è°ƒç”¨æ­¤å·¥å…·åå¯ä»¥ç«‹å³åˆ›å»ºæ–°è®¡åˆ’ã€‚`,
        parameters: {
          type: 'object',
          properties: {
            reason: {
              type: 'string',
              description: 'å½’æ¡£è®¡åˆ’çš„åŸå› ï¼ˆå¯é€‰ï¼Œä¼šæ˜¾ç¤ºåœ¨å½’æ¡£è®°å½•ä¸­ï¼‰'
            }
          }
        }
      }
    }
  ]

  // å¦‚æœæœ‰ MCP æœåŠ¡ï¼Œæ·»åŠ  MCP å·¥å…·
  if (mcpService) {
    const mcpTools = mcpService.getToolDefinitions()
    return [...builtinTools, ...mcpTools]
  }

  return builtinTools
}
